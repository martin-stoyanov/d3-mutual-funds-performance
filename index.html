<html>
  <head>
      <script src="https://d3js.org/d3.v5.min.js"></script>
  </head>
  <style>
    .gridlines line {
      stroke: lightgray;
      stroke-opacity: 0.7;
    }

    .gridlines path {
      stroke-width: 0;
    }
    
  </style>
  <body>
    <div style = "margin-left: 30px; margin-right: 30px;">
      <svg id="line_chart" height="490" width="900" style="text-align:center; background: #fff;" ></svg>
      <script>
        // 2007-2019 performance of 20 of the best mutual funds from 1987-2007 compared to S&P500, from
        // https://www.thestreet.com/story/10385337/1/best-performing-funds-over-the-past-20-years.html
        // all funds on list except for VCAGX, can't find data on it

        const getFundsData = async () => {
          const funds = ["VGHCX", "KAUAX", "VGENX", "FPPTX", "FSCSX", "FCNTX",
            "UNSCX", "SLMCX", "FSLBX", "FSRBX", "VGRIX", "FSPCX", "LLPFX", "FSHCX", "FSVLX",
            "ETHSX", "MPGFX", "JAVLX", "SPECX", "^GSPC"];
          let historicalPrices = {};
          let fundData = {};
          let monthlyData = {};
        
          for await (const fund of funds) {
            monthlyData = {};
            let prices = await Promise.all([
              await d3.csv(`./datasets/${fund}.csv`)
            ]);            
            prices[0].forEach( (month) => {
              if(!(month.Close === "null")){
                monthlyData[month.Date] = Number(month.Close);
              }
            });

            historicalPrices[fund] = monthlyData;
            //console.log(historicalPrices);
          };
          return d3.entries(historicalPrices);
        }
        
        getFundsData().then( (fundsData) => {
          console.log(fundsData);
          let svg = d3.select("svg#line_chart");
          const margin = {top: 50, right: 50, bottom: 50, left: 50}
          const width = window.innerWidth - margin.left - margin.right // Use the window's width 
          const height = window.innerHeight - margin.top - margin.bottom; // Use the window's height

          
          // getting mins and maxes for line chart data
          let maxPrice = 00000000; // a small number
          let minPrice = 99999999; // a big #
          let maxDate = "0000000"; // a small #
          let minDate = "9999999"; // a big #
          d3.entries(fundsData).forEach( (d,i) => {
            if(d3.max(Object.values(d["value"]["value"])) >= maxPrice) {
              maxPrice = d3.max(Object.values(d["value"]["value"]));
            }
            if(d3.min(Object.values(d["value"]["value"])) <= minPrice) {
              minPrice = d3.min(Object.values(d["value"]["value"]));
            }
            if(d3.min(Object.keys(d["value"]["value"])) >= maxDate) {
              maxDate = d3.max(Object.keys(d["value"]["value"]));
            }
            if(d3.min(Object.keys(d["value"]["value"])) <= minDate) {
              minDate = d3.min(Object.keys(d["value"]["value"]));
            }
          });

          console.log(new Date(minDate));
          console.log(new Date(maxDate));
          const xScale = d3.scaleTime()
            .domain([new Date(minDate), new Date(maxDate)])
            .range([0, width]);

          console.log(xScale("2007-05-01"));
        
          const yScale = d3.scaleLinear()
            .domain([minPrice, maxPrice])
            .range([height, 0]);

          var line = d3.line()
            .x(function(d, i) { return xScale(d); }) // set the x values for the line generator
            .y(function(d) { return yScale(d.y); }) // set the y values for the line generator 
            .curve(d3.curveMonotoneX) // apply smoothing to the line

          let bottomAxis = d3.axisBottom(xScale)
            .ticks(10)
            .tickFormat( d => (d.getMonth() + 1) + '/' +  d.getFullYear())
            .tickSize(0);

          let leftAxis = d3.axisLeft(yScale)
            .ticks(5)
            .tickFormat( d => d ) 
            .tickSize(0);

          svg.append("g")
            .attr("class", "y axis")
            .attr("transform","translate("+(margin.left)+","+(margin.top)+")")
            .style("font", "12px Roboto")
            .call(leftAxis)
            .selectAll("text");

          svg.append("g")
            .attr("class", "x axis")
            .attr("transform","translate("+(margin.left)+","+(height + margin.top)+")")
            .style("font", "12px Roboto")
            .call(bottomAxis)
            .selectAll("text")
              .attr("y", 0)
              .attr("x", 9)
              .attr("dy", ".55em")
              .attr("transform", "rotate(45)")
              .style("text-anchor", "start");

          var dataset = d3.range(21).map(function(d) { return {"y": d3.randomUniform(1)() } })
          //console.log(dataset); 
        });

      </script>
    </div>
  </body>
</html>